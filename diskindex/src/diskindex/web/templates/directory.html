{% extends "layout.html" %}

{% block title %}Directory: {{ directory.path }} - Diskindex{% endblock %}

{% block content %}
<h1>üìÅ Directory Browser</h1>

<div class="card">
    <h2>{{ directory.path }}</h2>
    <p><strong>Scan:</strong> <a href="/scan/{{ directory.scan_id }}">{{ directory.scan_path }}</a></p>

    {% if directory.parent_id %}
    <div style="margin: 1rem 0;">
        <a href="/directory/{{ directory.parent_id }}" class="btn">‚¨ÜÔ∏è Parent Directory</a>
    </div>
    {% endif %}

    <div style="margin: 1rem 0;">
        <form method="post" action="/directory/{{ directory.id }}/check_duplicates">
            <button type="submit" class="btn">üîç Check Duplicates</button>
        </form>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
        <div class="stat-card">
            <h3>Files</h3>
            <div class="value">{{ "{:,}".format(total_files) }}</div>
        </div>
        <div class="stat-card">
            <h3>Total Size</h3>
            <div class="value">{{ total_size | filesizeformat }}</div>
        </div>
    </div>
</div>

{% if subdirs %}
<div class="card">
    <h2>üìÇ Subdirectories ({{ subdirs|length }})</h2>
    <div class="table-responsive">
    <table>
        <thead>
            <tr>
                <th>Path</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for subdir in subdirs %}
            <tr>
                <td class="path-cell" title="{{ subdir.path }}">
                    <a href="/directory/{{ subdir.id }}">üìÅ <code>{{ subdir.path }}</code></a>
                </td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <form method="post" action="/directory/{{ subdir.id }}/delete/soft/recursive" style="display: inline;">
                            <button type="submit" class="btn-small btn-warning" title="Mark directory tree as deleted">
                                Soft Delete (Recursive)
                            </button>
                        </form>
                        <form method="post" action="/directory/{{ subdir.id }}/delete/hard/recursive"
                              style="display: inline;"
                              onsubmit="return confirm('‚ö†Ô∏è RECURSIVELY DELETE ENTIRE DIRECTORY TREE FROM DISK?\n\nPath: {{ subdir.path }}\n\nThis will delete the directory and ALL subdirectories!\n\nThis action CANNOT be undone!');">
                            <button type="submit" class="btn-small btn-danger" title="Delete directory tree from filesystem">
                                Hard Delete (Recursive)
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>
{% endif %}

{% if files %}
<div class="card">
    <h2>üìÑ Files ({{ files|length }})</h2>
    <div class="table-responsive">
    <table>
        <thead>
            <tr>
                <th>Filename</th>
                <th>Extension</th>
                <th>Size</th>
                <th>Modified</th>
                <th>MD5</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td><strong>{{ file.filename }}</strong></td>
                <td><code>{{ file.extension or '-' }}</code></td>
                <td>{{ file.size | filesizeformat }}</td>
                <td>{{ file.mtime | datetimeformat }}</td>
                <td>
                    {% if file.md5 %}
                    <code style="font-size: 0.75em;">{{ file.md5[:16] }}...</code>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 0.25rem;">
                        <form method="post" action="/file/{{ file.id }}/delete/soft" style="display: inline;">
                            <button type="submit" class="btn-small btn-warning" title="Mark as deleted in database">
                                Soft
                            </button>
                        </form>
                        <form method="post" action="/file/{{ file.id }}/delete/hard"
                              style="display: inline;"
                              onsubmit="return confirm('‚ö†Ô∏è Delete file from disk?\n\nFile: {{ file.filename }}\n\nThis action cannot be undone!');">
                            <button type="submit" class="btn-small btn-danger" title="Delete from filesystem">
                                Hard
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>
{% else %}
<div class="card">
    <p>No files in this directory.</p>
</div>
{% endif %}

<div class="card" style="margin-top: 1rem; background: #fff3cd; border-left: 4px solid #ffc107;">
    <h3>‚ö†Ô∏è Directory Actions</h3>
    <p><strong>Recursive deletion:</strong> Delete this directory and all subdirectories/files within it.</p>
    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <form method="post" action="/directory/{{ directory.id }}/delete/soft/recursive" style="display: inline;">
            <button type="submit" class="btn btn-warning"
                    onclick="return confirm('Mark this directory tree ({{ total_files }} file(s)) as deleted in the database?');">
                Soft Delete (Recursive)
            </button>
        </form>
        <form method="post" action="/directory/{{ directory.id }}/delete/hard/recursive"
              style="display: inline;"
              onsubmit="return confirm('‚ö†Ô∏è RECURSIVELY DELETE ENTIRE DIRECTORY TREE FROM DISK?\n\nThis will delete {{ total_files }} file(s) and all subdirectories.\n\nThis action CANNOT be undone!');">
            <button type="submit" class="btn btn-danger">
                Hard Delete (Recursive)
            </button>
        </form>
    </div>
    <hr style="margin: 1.5rem 0;">
    <p><strong>Naive deletion:</strong> Delete only direct files in this directory (excludes subdirectories).</p>
    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <form method="post" action="/directory/{{ directory.id }}/delete/soft" style="display: inline;">
            <button type="submit" class="btn btn-warning"
                    onclick="return confirm('Mark {{ total_files }} direct file(s) in this directory as deleted?');">
                Soft Delete (Naive)
            </button>
        </form>
        <form method="post" action="/directory/{{ directory.id }}/delete/hard"
              style="display: inline;"
              onsubmit="return confirm('‚ö†Ô∏è DELETE DIRECT FILES IN THIS DIRECTORY FROM DISK?\n\nThis will delete {{ total_files }} direct file(s) only.\n\nThis action CANNOT be undone!');">
            <button type="submit" class="btn btn-danger">
                Hard Delete (Naive)
            </button>
        </form>
    </div>
</div>

{% endblock %}
