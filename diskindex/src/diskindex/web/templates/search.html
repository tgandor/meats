{% extends "layout.html" %}
{% from "_pagination.html" import render_pagination %}

{% block title %}Search Files - Diskindex{% endblock %}

{% block content %}
<h1>Search Files</h1>

<div class="card">
    <form class="search-form" method="get" action="/search">
        <input type="text" name="q" placeholder="Filename..." value="{{ query }}">
        <input type="text" name="ext" placeholder="Extension (e.g., .jpg)" value="{{ extension }}">
        <input type="number" name="min_size" placeholder="Min size (bytes)" value="{{ min_size or '' }}">
        <input type="number" name="max_size" placeholder="Max size (bytes)" value="{{ max_size or '' }}">

        <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="unique_only" value="1" {% if unique_only %}checked{% endif %}>
                <span>Unique files only (exclude duplicates)</span>
            </label>

            <select name="scan_id" style="flex: 1;">
                <option value="">All scans</option>
                {% for scan in scans %}
                <option value="{{ scan.id }}" {% if scan_id == scan.id %}selected{% endif %}>
                    #{{ scan.id }} - {{ scan.path }} ({{ (scan.date | datetimeformat)[:16] }}, {{ "{:,}".format(scan.file_count) }} files)
                </option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn" style="margin-top: 0.5rem;">Search</button>
    </form>
</div>

{% if results is defined %}
<div class="card">
    <h2>Results {% if pagination %}({{ pagination.total_count }} total){% else %}({{ results|length }}){% endif %}</h2>
    {% if results %}
    <div class="table-responsive">
    <table>
        <thead>
            <tr>
                <th>Filename</th>
                <th>Extension</th>
                <th>Size</th>
                <th>Modified</th>
                <th>MD5</th>
                <th>Path</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for file in results %}
            <tr>
                <td><strong>{{ file.filename }}</strong></td>
                <td><code>{{ file.extension or '-' }}</code></td>
                <td>{{ file.size | filesizeformat }}</td>
                <td>{{ file.mtime | datetimeformat }}</td>
                <td>
                    {% if file.md5 %}
                    <code style="font-size: 0.75em;">{{ file.md5[:16] }}...</code>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="path-cell" title="{{ file.path }}">
                    <code style="font-size: 0.85em;">{{ file.path }}</code>
                    <a href="/directory/{{ file.directory_id }}" title="Browse directory" style="margin-left: 0.5rem;">üìÅ</a>
                </td>
                <td>
                    <div style="display: flex; gap: 0.25rem;">
                        <form method="post" action="/file/{{ file.id }}/delete/soft" style="display: inline;">
                            <button type="submit" class="btn-small btn-warning" title="Mark as deleted in database">
                                Soft
                            </button>
                        </form>
                        <form method="post" action="/file/{{ file.id }}/delete/hard"
                              style="display: inline;"
                              onsubmit="return confirm('‚ö†Ô∏è Delete file from disk?\n\nPath: {{ file.path }}\n\nThis action cannot be undone!');">
                            <button type="submit" class="btn-small btn-danger" title="Delete from filesystem">
                                Hard
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>

    {% if pagination %}
    {% set kwargs = {'q': query, 'ext': extension, 'min_size': min_size, 'max_size': max_size, 'unique_only': '1' if unique_only else '', 'scan_id': scan_id or ''} %}
    {{ render_pagination(pagination, 'search', **kwargs) }}
    {% endif %}
    {% else %}
    <p>No files found matching your criteria.</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}
