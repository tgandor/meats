{% extends "layout.html" %}

{% block title %}Scan #{{ scan.id }} - Diskindex{% endblock %}

{% block content %}
<h1>Scan #{{ scan.id }}</h1>

<div style="margin-bottom: 1rem;">
    <a href="/scans" class="btn">‚Üê Back to Scans</a>
    <button class="btn btn-danger" onclick="confirmDelete({{ scan.id }}, '{{ scan.path }}')">Delete Scan</button>
</div>

<div class="card">
    <h2>Scan Information</h2>
    <table>
        <tr>
            <th style="width: 200px;">Scan Date</th>
            <td>{{ scan.date | datetimeformat }}</td>
        </tr>
        <tr>
            <th>Path</th>
            <td>
                <code>{{ scan.path }}</code>
                {% if scan.root_directory_id %}
                <a href="/directory/{{ scan.root_directory_id }}" class="btn-small" style="margin-left: 1rem;">üìÅ Browse</a>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Duration</th>
            <td>{{ "%.1f" | format(scan.duration or 0) }} seconds</td>
        </tr>
        <tr>
            <th>Files</th>
            <td>{{ "{:,}".format(scan.file_count) }}</td>
        </tr>
        <tr>
            <th>Total Size</th>
            <td>{{ scan.total_size | filesizeformat }}</td>
        </tr>
        <tr>
            <th>Notes</th>
            <td>{{ scan.notes or '-' }}</td>
        </tr>
    </table>
</div>

{% if volumes %}
<div class="card">
    <h2>Volume Information</h2>
    {% for volume in volumes %}
    <table style="margin-bottom: 1rem;">
        <tr>
            <th style="width: 200px;">Label</th>
            <td>{{ volume.label }}</td>
        </tr>
        <tr>
            <th>Filesystem</th>
            <td>{{ volume.filesystem or '-' }}</td>
        </tr>
        <tr>
            <th>Total Size</th>
            <td>{{ volume.total_size | filesizeformat if volume.total_size else '-' }}</td>
        </tr>
        <tr>
            <th>Free Space</th>
            <td>
                {% if volume.free_space and volume.total_size %}
                {{ volume.free_space | filesizeformat }} ({{ "%.1f" | format((volume.free_space / volume.total_size) * 100) }}% free)
                {% else %}
                -
                {% endif %}
            </td>
        </tr>
        {% if volume.uuid %}
        <tr>
            <th>UUID</th>
            <td><code style="font-size: 0.85em;">{{ volume.uuid }}</code></td>
        </tr>
        {% endif %}
        {% if volume.drive_type %}
        <tr>
            <th>Drive Type</th>
            <td>{{ volume.drive_type }}</td>
        </tr>
        {% endif %}
        {% if volume.mount_options %}
        <tr>
            <th>Mount Options</th>
            <td><code style="font-size: 0.85em;">{{ volume.mount_options }}</code></td>
        </tr>
        {% endif %}
    </table>
    {% endfor %}
</div>
{% endif %}

<div class="card">
    <h2>Top File Types</h2>
    {% if extensions %}
    <table>
        <thead>
            <tr>
                <th>Extension</th>
                <th>Count</th>
                <th>Total Size</th>
            </tr>
        </thead>
        <tbody>
            {% for ext in extensions %}
            <tr>
                <td><code>{{ ext.ext }}</code></td>
                <td>{{ "{:,}".format(ext.count) }}</td>
                <td>{{ ext.size | filesizeformat }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No files found in this scan.</p>
    {% endif %}
</div>

<a href="/scans" class="btn btn-secondary">‚Üê Back to Scans</a>

<!-- Delete confirmation modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h2>‚ö†Ô∏è Delete Scan</h2>
        <p>Are you sure you want to delete this scan?</p>
        <p><strong>Path:</strong> <code id="deleteScanPath"></code></p>
        <p>This will permanently delete the scan and all associated file records.</p>
        <form id="deleteForm" method="POST">
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete</button>
            </div>
        </form>
    </div>
</div>

<script>
function confirmDelete(scanId, scanPath) {
    document.getElementById('deleteScanPath').textContent = scanPath;
    document.getElementById('deleteForm').action = '/scan/' + scanId + '/delete';
    document.getElementById('deleteModal').classList.add('active');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
}

// Close modal on background click
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>
{% endblock %}
